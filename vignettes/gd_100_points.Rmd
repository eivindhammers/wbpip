---
title: "100 points distributions with Group Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{100 points distributions with Group Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(wbpip)
library(data.table)
```


# Aux data

```{r load-aux}

pfw <- pipload::pip_load_aux("pfw") |> 
  {\(.) .[use_groupdata == 1]}()

gdm <- pipload::pip_load_aux("gdm") 

cpi <- pipload::pip_load_aux("cpi") 

ppp <- pipload::pip_load_aux("ppp") 

```


## filter data 

```{r filter-data}

fpf <- pfw[, .(country_code, 
               year, 
               surveyid_year,
               reporting_year,
               survey_year,
               survey_coverage, 
               welfare_type
               )]

```



```{r function}







country  <- "ARE"
year     <- 2019
coverage <- "national"

cond <- "country_code == country & 
            survey_year  == (year-1) &
            tolower(pop_data_level) == coverage"
cond <- parse(text = cond)


dt   <- pipload::pip_load_cache(country, year)
dtm <- pipload::pip_load_aux("gdm") |> 
  {\(.) .[eval(cond),
          survey_mean_lcu ]}()


cpi <- pipload::pip_load_aux("cpi") |> 
  setnames("cpi_data_level", "pop_data_level") |> 
  {\(.) .[eval(cond), cpi2017]}()



ppp <- pipload::pip_load_aux("ppp")  |> 
  {\(.) .[country_code == country &
            ppp_year == 2017 &
            ppp_default_by_year  == TRUE & 
            ppp_data_level == coverage, 
          ppp]}() 




welfare    <-  dt$welfare
population <-  dt$weight
mean       <- 
  wbpip::deflate_welfare_mean(welfare_mean = dtm, 
                              ppp = ppp, 
                              cpi = cpi) |>
  {\(.) ./(365/12)}()



# Get quantiles

# lorenz <- "lq"
nq <- 10
lorenz <- NULL
# lorenz <- "lb"
popshare <- seq(from = 1/nq, to = 1, by = 1/nq)

params <- get_gd_quantiles(welfare,
                           population,
                           complete = TRUE, 
                           mean     = mean,
                           popshare = popshare, 
                           lorenz = lorenz)

povlines <- params$dist_stats$quantiles
lorenz   <- params$selected_lorenz$for_dist


wlf_share <- 
  get_gd_wlf_share_by_qtl(params = params, 
                          lorenz = lorenz, 
                          n      = nq) |> 
  {\(.) .$dist_stats$welfare_share}()
  
pop_share <- c(popshare[1], diff(popshare))

avg_wlf_qtl <- (wlf_share*mean)/pop_share

dt <- data.table(
  country_code = country, 
  year         = year, 
  coverage     = coverage, 
  quantile    = povlines, 
  welfare_share = wlf_share, 
  pop_share     = pop_share,
  avg_welfare   = avg_wlf_qtl
)

dt[, bin := .I
   ][bin == max(bin), 
     quantile := NA_real_]

```

